---
title: "Corona Model"
author: "Abdelrahman Hammad"
date: "3/21/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```




```{r formatting and part a}
#these libraries are necessary

install.packages(forecast)
install.packages("lubridate")
install.packages("ggplot2")


library(readxl)
library(dplyr)
library(httr)
library(tseries)
library(astsa)
library(forecast)


#create the URL where the dataset is stored with automatic updates every day
url <- paste("https://www.ecdc.europa.eu/sites/default/files/documents/COVID-19-geographic-disbtribution-worldwide-",format(Sys.time(), "%Y-%m-%d"), ".xlsx", sep = "")

#download the dataset from the website to a local temporary file
GET(url, authenticate(":", ":", type="ntlm"), write_disk(tf <- tempfile(fileext = ".xlsx")))

#read the Dataset sheet into “R”
file <- read_excel(tf)

# make sure the date is formatted properly
file$dateRep <- as.POSIXct(file$dateRep, format = "%Y-%m-%d", tz = "America/New_York")

# subset data - eliminate approximately 10% of data
subsetfile <- subset(file, dateRep >= as.POSIXct('2020-01-01') & dateRep 
            <= as.POSIXct('2020-03-10'))

```

```{r start analysis}
US <- filter(subsetfile, geoId == "US")

US_data  <- data.frame(Cases = US$cases)

US_data  <- US_data[order(US_data$Cases),]


US_series <- ts(US_data)

plot(US_series)
```

Description of the data:

	 The chosen dataset contains the amount of new cases of COVID-19 diagnosed daily across all infected countries. This project will specifically focus on COVID-19 cases reported per day in the United States since January 2, 2020. It was obtained from the European Union CDC equivalent ( European Union Center for Disease Control and Prevention ) and is updated daily with the amount of new cases. This growing data set is mitigated by only keeping track of a two month (60 days) span during the peak of the outbreak in the United States.

```{r part b}
acf2(US_series)

#We must first observe a second wave before we can consider seasonality 
#calling the acf function we can observe that the model is an AR(1) model 
```

```{r sdf_test}

#Let's test for serial correlation of the data...
Box.test(US_series, type = "Ljung-Box")

#Let's check if the data is stationary...
adf.test(US_series, alternative = "stationary")

``` 


```{r transformation/differencing}
# cube root tranformation
cuberoot_US_series = (US_series)^(1/3)
plot(cuberoot_US_series,type = 'l')

# cube root first difference
US_series_cube_diff1 = diff(cuberoot_US_series)
plot(US_series_cube_diff1, type='l')

# cube root second difference
US_series_cube_diff2 = diff(US_series_cube_diff1)
plot(US_series_cube_diff2, type='l')

###-------------------------------------------------

# checking for autocorrelation
Box.test(US_series_cube_diff2, type = "Ljung-Box")

# checking stationarity of cube root second difference 
adf.test(US_series_cube_diff2, alternative = "stationary")

```


Transformations and Differencing to Achieve Stationarity

	From the plot of the data, there is an obvious increasing exponential trend in the number of cases over time. In order to make the data stationary, the data went through a cube root transformation and second differencing. This was proven by using the Augmented Dickey-Fuller Test which provided a significant p-value. 

```{r model selection}
acf2(US_series_cube_diff2)

# fitting several models
MA1_diff_2 = sarima(US_series_cube_diff2, p=0, d=0, q=1)
MA1_diff_2

AR1_diff_2 = sarima(US_series_cube_diff2, p=1, d=0, q=0)
AR1_diff_2

AR4_diff_2 = sarima(US_series_cube_diff2, p=4, d=0, q=0)
AR4_diff_2

```

Model Selection:

  From the ACF and PACF of the transformed data, there were several model options to explore ( MA(1), AR(1), AR(4) ). The best model for the data is the AR(4) model because it had the lowest variance, lowest AIC, and lowest BIC. 

Residual Analysis:

	With the AR(4) model, most of the residual assumptions are satisfied. For example, the assumptions of normality, correlation, and independence of the residuals have been satisfied. However, the standardized residuals are not uniformly distributed around the mean. 

```{r model_fitting}

models <- forecast(US_series, h = 7)

summary(models)


plot(forecast(models))

models
```

```{r infected cases}

infected = 0

infected_rates = c(1:84)

for(i in 1:84){
  
  infected = infected + US_data[i]
  infected_rates[i] = infected
}

infected_ts = ts(infected_rates)
plot(infected_ts)

```



```{r model_fitting2}

model2 <- forecast(infected_ts, h = 7)

summary(model2)

plot(forecast(model2))

model2
```


